{
  "module": "composeVideo with audio pass-through",
  "locations": [
    "lib/watermark_kit_method_channel.dart: video task creation + callbacks wiring",
    "ios/Classes/WatermarkApiImpl.swift: forwards composeVideo to VideoWatermarkProcessor",
    "ios/Classes/VideoWatermarkProcessor.swift: AVAssetReader/Writer pipeline; optional audio pass-through",
    "android/src/main/kotlin/com/tttocklll/watermark_kit/video/VideoWatermarkProcessor.kt: MediaMuxer pipeline (works with audio)",
    "example/lib/main.dart: sample composeVideo usage"
  ],
  "current_behavior": "Dart side issues composeVideo via pigeon, registers callbacks, and resolves when native calls onVideoCompleted/onVideoError (watchdog already present). iOS pipeline reads video via AVAssetReader (BGRA), overlays via CI, writes via AVAssetWriter. Audio track is optional: AVAssetReaderTrackOutput with outputSettings=nil and AVAssetWriterInput(audio, outputSettings=nil). Audio samples are appended opportunistically inside the video loop and drained once more after video finishes. Android pipeline muxes audio by copying samples asynchronously while video encoder runs.",
  "tech_stack": {
    "framework": "Flutter plugin using pigeon for platform channels",
    "languages": "Dart + Swift (AVFoundation) + Kotlin (MediaCodec/MediaMuxer)",
    "async_model": "Per-task streams/completer on Dart; native pipelines post callbacks via WatermarkCallbacks"
  },
  "tests": [
    "test/video_callbacks_test.dart: progress/completion/error routing via mocked pigeon channel",
    "test/watermark_kit_test.dart: composeVideo API defaults",
    "no automated test covers audio preservation"
  ],
  "observation": {
    "risks": [
      "iOS audio path best-effort only; audio append tied to video loop readiness and may be skipped",
      "Audio reader/writer created but writer inputs may never start if not requested on a dedicated queue",
      "No validation that audio track exists in output; silent failures possible"
    ],
    "info_gaps": [
      "Exact sample video/audio formats that fail (source codec, channels, rate)",
      "Whether outputSettings=nil for AVAssetWriterInput is incompatible for some inputs/fileType",
      "Whether audio samples are appended after writer.startSession and before finishWriting"
    ]
  }
}
